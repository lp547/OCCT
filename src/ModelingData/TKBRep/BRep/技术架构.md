# OCCT BRep 模块技术架构文档

## 1. 架构概览 (Architecture Overview)

`BRep` 模块采用了 **桥接模式 (Bridge Pattern)** 和 **组合模式 (Composite Pattern)** 的混合架构，用于连接 `TopoDS`（拓扑定义）和 `Geom`（几何定义）。

*   **继承架构**：`BRep` 中的类（如 `BRep_TFace`）继承自 `TopoDS` 中的抽象基类（如 `TopoDS_TFace`）。
*   **关联架构**：`BRep` 类持有 `Geom` 类（如 `Geom_Surface`）的句柄（Handle）。

## 2. 类图 (Class Diagram)

```mermaid
classDiagram
    %% TopoDS 层的抽象定义
    class TopoDS_TShape {
        <<Abstract>>
    }
    class TopoDS_TFace {
        <<Abstract>>
    }
    class TopoDS_TEdge {
        <<Abstract>>
    }
    class TopoDS_TVertex {
        <<Abstract>>
    }

    %% BRep 层的具体实现
    class BRep_TFace {
        -Handle(Geom_Surface) mySurface
        -TopLoc_Location myLocation
        -double myTolerance
        +Surface()
        +Triangulation()
    }
    class BRep_TEdge {
        -double myTolerance
        -BRep_ListOfCurveRepresentation myCurves
        +Curves()
    }
    class BRep_TVertex {
        -gp_Pnt myPnt
        -double myTolerance
        -BRep_ListOfPointRepresentation myPoints
        +Pnt()
    }

    %% 几何层
    class Geom_Surface
    class BRep_CurveRepresentation {
        <<Abstract>>
        +IsCurve3D()
        +IsCurveOnSurface()
    }
    class BRep_Curve3D
    class BRep_CurveOnSurface

    %% 继承关系
    TopoDS_TShape <|-- TopoDS_TFace
    TopoDS_TShape <|-- TopoDS_TEdge
    TopoDS_TShape <|-- TopoDS_TVertex

    TopoDS_TFace <|-- BRep_TFace
    TopoDS_TEdge <|-- BRep_TEdge
    TopoDS_TVertex <|-- BRep_TVertex

    %% 关联关系
    BRep_TFace --> Geom_Surface : 拥有
    BRep_TEdge --> BRep_CurveRepresentation : 拥有列表
    BRep_CurveRepresentation <|-- BRep_Curve3D
    BRep_CurveRepresentation <|-- BRep_CurveOnSurface
```

## 3. 关键数据结构与算法 (Key Data Structures & Algorithms)

### 3.1 面的数据结构 (`BRep_TFace`)
*   **核心字段**：
    *   `mySurface`: `Handle(Geom_Surface)` - 指向几何曲面的智能指针。
    *   `myLocation`: `TopLoc_Location` - 面相对于其定义位置的局部坐标变换。
    *   `myTolerance`: `Standard_Real` - 面的几何误差容限。
*   **设计意图**：将几何曲面与拓扑面解耦。位置 (`Location`) 的存在允许同一个几何曲面在空间不同位置被复用（虽然在 Face 级别较少见，但在更上层的 Instance 中很常见）。

### 3.2 边的数据结构 (`BRep_TEdge`)
*   **核心字段**：
    *   `myCurves`: `BRep_ListOfCurveRepresentation` - 这是一个多态列表。
*   **设计意图 (重要)**：一条边在 3D 空间中是一条曲线，但在它所属的每个面上，它也是一条 2D 参数曲线 (pcurve)。
    *   如果一条边是两个面的公共边界，它将包含：
        1.  一个 `BRep_Curve3D` (可选，但在显示时通常需要)。
        2.  两个 `BRep_CurveOnSurface` (分别对应两个面)。
    *   算法在处理边时，会遍历这个列表找到与当前上下文（例如“我在哪个面上处理这条边？”）匹配的表示。

### 3.3 访问者模式/工具类 (`BRep_Tool`)
*   OCCT 不鼓励直接转换（Cast）`TopoDS_Shape` 到 `BRep` 类来访问数据。
*   **设计模式**：使用 `BRep_Tool` 作为静态访问器。
*   **流程**：
    1.  用户持有 `TopoDS_Face`。
    2.  调用 `BRep_Tool::Surface(face)`。
    3.  `BRep_Tool` 内部提取 `TopoDS_TShape`，向下转型为 `BRep_TFace`，获取 `Geom_Surface`，并应用 `Face` 的 `Location`。

## 4. 关键接口说明 (Key Interface Descriptions)

以下列出系统中关键模块的函数接口说明。

### 4.1 `BRep_Builder` (构建器)

| 函数接口 (Signature) | 输入参数 (Input) | 输出参数 (Output) | 功能说明 (Functionality) |
| :--- | :--- | :--- | :--- |
| `MakeFace(TopoDS_Face& F, const Handle(Geom_Surface)& S, const Standard_Real Tol)` | `S`: 几何曲面<br>`Tol`: 公差 | `F`: 构建好的拓扑面 | 创建一个新的面，并将几何曲面 `S` 绑定到该面上。 |
| `MakeEdge(TopoDS_Edge& E, const Handle(Geom_Curve)& C, const Standard_Real Tol)` | `C`: 3D 几何曲线<br>`Tol`: 公差 | `E`: 构建好的拓扑边 | 创建一条边，并赋予其 3D 空间曲线几何。 |
| `UpdateEdge(const TopoDS_Edge& E, const Handle(Geom2d_Curve)& C, const TopoDS_Face& F, const Standard_Real Tol)` | `E`: 待更新的边<br>`C`: 2D 参数曲线<br>`F`: 所在的参照面<br>`Tol`: 公差 | 无 (Void) | 为已有的边添加在特定面 `F` 上的 2D 参数曲线表示 (PCurve)。这是建立拓扑连接性的关键步骤。 |
| `MakeVertex(TopoDS_Vertex& V, const gp_Pnt& P, const Standard_Real Tol)` | `P`: 3D 笛卡尔坐标点<br>`Tol`: 公差 | `V`: 构建好的拓扑顶点 | 创建一个顶点，并赋予其确定的空间坐标。 |

### 4.2 `BRep_Tool` (工具类)

| 函数接口 (Signature) | 输入参数 (Input) | 输出参数 (Output) | 功能说明 (Functionality) |
| :--- | :--- | :--- | :--- |
| `Surface(const TopoDS_Face& F, TopLoc_Location& L)` | `F`: 目标拓扑面 | `L`: 返回曲面的位置变换<br>**Return**: `Handle(Geom_Surface)` | 获取面对应的几何曲面对象以及其位置变换矩阵。 |
| `Curve(const TopoDS_Edge& E, Standard_Real& First, Standard_Real& Last)` | `E`: 目标拓扑边 | `First`, `Last`: 曲线的参数范围<br>**Return**: `Handle(Geom_Curve)` | 获取边的 3D 几何曲线及其参数区间。如果边没有 3D 曲线，返回 Null。 |
| `CurveOnSurface(const TopoDS_Edge& E, const TopoDS_Face& F, Standard_Real& First, Standard_Real& Last)` | `E`: 目标边<br>`F`: 参照面 | `First`, `Last`: 参数范围<br>**Return**: `Handle(Geom2d_Curve)` | 获取边 `E` 在面 `F` 上的 2D 参数曲线 (PCurve)。用于参数空间计算。 |
| `Pnt(const TopoDS_Vertex& V)` | `V`: 目标顶点 | **Return**: `gp_Pnt` (3D 点) | 获取顶点的 3D 坐标。 |

## 5. 数据流图 (Data Flow Diagram)

**场景：构建一条边 (Edge Construction Flow)**

```mermaid
sequenceDiagram
    participant User as 用户代码
    participant Builder as BRep_Builder
    participant TEdge as BRep_TEdge
    participant CurveList as ListOfCurveRep
    participant Geom as Geom_Curve

    User->>Geom: 创建 Geom_Line (几何)
    User->>Builder: MakeEdge(Edge, Geom_Line, Tolerance)
    activate Builder
    Builder->>TEdge: new BRep_TEdge() (创建数据结构)
    activate TEdge
    TEdge->>CurveList: 初始化列表
    deactivate TEdge
    Builder->>Builder: 创建 BRep_Curve3D (封装几何)
    Builder->>TEdge: AddCurveRepresentation(BRep_Curve3D)
    TEdge->>CurveList: Append()
    Builder-->>User: 返回 TopoDS_Edge (指向 TEdge)
    deactivate Builder
```

## 6. 核心算法流程 (Core Algorithm Flow)

### 6.1 边的同一性检查 (Same Parameter)
在 `BRep` 结构中，边可以有 3D 曲线和 2D 曲线。OCCT 要求它们满足 "Same Parameter" 属性，即同一个参数 $t$ 在 3D 曲线上的点
$$
C_{3d}(t)
$$
和在 2D 曲线上的点映射到 3D 空间后 
$$
S(C_{2d}(t))
$$
之间的距离必须小于公差。

**算法流程**：
1.  输入：一条边 `E`。
2. 获取 `E` 的 3D 曲线 
   $$
   C_{3d}
   $$
   和面 `F` 上的 2D 曲线 $
   $$
   C_{2d}
   $$
   $。
3.  在参数范围 $[t_{min}, t_{max}]$ 内进行采样。
4.  对于每个采样点 $t_i$：
    *   计算 $P_1 = C_{3d}(t_i)$
    *   计算 $uv = C_{2d}(t_i)$
    *   计算 $P_2 = Surface(uv)$
    *   检查 $Distance(P_1, P_2) \le Tolerance$
5.  如果所有点都满足，标记 `SameParameter` 为 True。
6.  如果不满足，可能需要重新参数化 2D 曲线或扩大边的公差。


基于对源代码的详细分析，为您绘制了 `BRep` 模块的详细类图。

### BRep 模块类图 (Class Diagram)

这个类图展示了 `BRep` 如何通过继承 `TopoDS` 来实现具体的拓扑结构，并如何通过 `BRep_CurveRepresentation` 和 `BRep_PointRepresentation` 来灵活地存储几何信息。

```mermaid
classDiagram
    %% =========================================================
    %% 1. 核心拓扑实现 (Core Topology Implementation)
    %% =========================================================
    class TopoDS_TShape {
        <<Abstract>>
    }
    class TopoDS_TFace {
        <<Abstract>>
    }
    class TopoDS_TEdge {
        <<Abstract>>
    }
    class TopoDS_TVertex {
        <<Abstract>>
    }

    class BRep_TFace {
        -Handle(Geom_Surface) mySurface
        -TopLoc_Location myLocation
        -Standard_Real myTolerance
        -Handle(Poly_Triangulation) myTriangulation
    }
    
    class BRep_TEdge {
        -Standard_Real myTolerance
        -Standard_Boolean mySameParameter
        -Standard_Boolean mySameRange
        -Standard_Boolean myDegenerated
        -BRep_ListOfCurveRepresentation myCurves
        +Curves()
    }

    class BRep_TVertex {
        -gp_Pnt myPnt
        -Standard_Real myTolerance
        -BRep_ListOfPointRepresentation myPoints
        +Pnt()
    }

    TopoDS_TShape <|-- TopoDS_TFace
    TopoDS_TShape <|-- TopoDS_TEdge
    TopoDS_TShape <|-- TopoDS_TVertex

    TopoDS_TFace <|-- BRep_TFace
    TopoDS_TEdge <|-- BRep_TEdge
    TopoDS_TVertex <|-- BRep_TVertex

    %% =========================================================
    %% 2. 边几何表示体系 (Curve Representation Hierarchy)
    %% =========================================================
    class BRep_CurveRepresentation {
        <<Abstract>>
        -TopLoc_Location myLocation
        +IsCurve3D()
        +IsCurveOnSurface()
        +IsPolygon3D()
    }

    class BRep_GCurve {
        <<Abstract>>
        -Standard_Real myFirst
        -Standard_Real myLast
        +SetRange()
    }

    class BRep_Curve3D {
        -Handle(Geom_Curve) myCurve
        +Curve3D()
    }

    class BRep_CurveOnSurface {
        -Handle(Geom2d_Curve) myPCurve
        -Handle(Geom_Surface) mySurface
        -gp_Pnt2d myUV1
        -gp_Pnt2d myUV2
        +PCurve()
        +Surface()
    }

    class BRep_Polygon3D {
        -Handle(Poly_Polygon3D) myPolygon3D
    }

    class BRep_PolygonOnTriangulation {
        -Handle(Poly_PolygonOnTriangulation) myPolygon
        -Handle(Poly_Triangulation) myTriangulation
    }

    BRep_CurveRepresentation <|-- BRep_GCurve
    BRep_CurveRepresentation <|-- BRep_Polygon3D
    BRep_CurveRepresentation <|-- BRep_PolygonOnTriangulation

    BRep_GCurve <|-- BRep_Curve3D
    BRep_GCurve <|-- BRep_CurveOnSurface

    %% =========================================================
    %% 3. 点几何表示体系 (Point Representation Hierarchy)
    %% =========================================================
    class BRep_PointRepresentation {
        <<Abstract>>
        -TopLoc_Location myLocation
        -Standard_Real myParameter
        +Parameter()
    }

    class BRep_PointOnCurve {
        -Handle(Geom_Curve) myCurve
    }

    class BRep_PointsOnSurface {
        -Handle(Geom_Surface) mySurface
    }

    class BRep_PointOnSurface {
        -Standard_Real myParameter2
    }

    BRep_PointRepresentation <|-- BRep_PointOnCurve
    BRep_PointRepresentation <|-- BRep_PointsOnSurface
    BRep_PointsOnSurface <|-- BRep_PointOnSurface

    %% =========================================================
    %% 4. 关系连接 (Relationships)
    %% =========================================================
    
    %% TEdge 拥有多种曲线表达
    BRep_TEdge "1" *-- "n" BRep_CurveRepresentation : contains list
    
    %% TVertex 拥有多种点表达
    BRep_TVertex "1" *-- "n" BRep_PointRepresentation : contains list

    %% =========================================================
    %% 5. 工具类 (Utility Classes)
    %% =========================================================
    class BRep_Builder {
        +MakeFace()
        +MakeEdge()
        +MakeVertex()
        +UpdateVertex()
    }
    class TopoDS_Builder
    TopoDS_Builder <|-- BRep_Builder

    class BRep_Tool {
        <<Static>>
        +Surface()
        +Curve()
        +Pnt()
        +Triangulation()
    }

```

### 图解说明

1.  **左侧 (Topology Implementation)**:
    *   **`BRep_TFace`**: 核心是存储了 `Geom_Surface`（几何面）和 `TopLoc_Location`（位置变换）。
    *   **`BRep_TEdge`**: 核心是 `myCurves` 列表。一条边可以同时拥有：
        *   一个 `BRep_Curve3D`（空间曲线，用于显示）。
        *   多个 `BRep_CurveOnSurface`（PCurve，用于在不同面上进行参数计算）。
        *   多个 `BRep_Polygon3D`（离散多边形，用于快速显示）。
    *   **`BRep_TVertex`**: 存储了确定的 3D 坐标 `myPnt`，同时也维护一个 `myPoints` 列表，记录该点在依附的边或面上的参数值。

2.  **中间 (Curve Representation Hierarchy)**:
    *   **`BRep_CurveRepresentation`**: 所有边几何的基类。
    *   **`BRep_GCurve`**: 引入了参数范围 `[First, Last]` 的概念，适用于解析曲线。
    *   **`BRep_Curve3D`**: 包装了 `Geom_Curve`。
    *   **`BRep_CurveOnSurface`**: 包装了 `Geom2d_Curve` 和 `Geom_Surface`。

3.  **右侧 (Point Representation Hierarchy)**:
    *   **`BRep_PointRepresentation`**: 所有点参数信息的基类，存储了一个参数 `myParameter` (U)。
    *   **`BRep_PointOnSurface`**: 继承自中间类 `BRep_PointsOnSurface`，增加了 `myParameter2` (V)，从而构成了 (U, V) 二维参数。

4.  **下方 (Tools)**:
    *   **`BRep_Builder`**: 负责创建上述复杂结构的“工厂”。
    *   **`BRep_Tool`**: 负责从上述结构中安全读取数据的“阅读器”。




下面基于源码里的定义把三类做“详细解释”，并补上你给的“一句话”描述的具体含义和在实现上的证据。  

**整体关系**
- 是“边的曲线表示”的统一基类，核心字段是 Location（位置变换），各具体表示继承它并补充自身数据；见 [BRep_CurveRepresentation.hxx:L44-L210](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_CurveRepresentation.hxx#L44-L210)
- BRep_GCurve 在此基础上增加参数范围 [First, Last]，并要求子类至少实现 D0（给定参数算 3D 点）；见 [BRep_GCurve.hxx:L35-L92](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_GCurve.hxx#L35-L92)

**BRep_GCurve（曲线表示 + 参数范围）**
- 作用：它是“带范围的曲线表示”抽象基类，承载 Location 与参数范围 [First, Last]，并定义 D0 作为统一几何采样入口；见 [BRep_GCurve.hxx:L35-L92](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_GCurve.hxx#L35-L92)
- 参数范围意义：First/Last 用来裁剪或限定一条边实际使用的参数区间，可能不同于几何曲线的完整范围；SetRange/First/Last 会触发 Update 以让子类更新缓存；见 [BRep_GCurve.hxx:L41-L69](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_GCurve.hxx#L41-L69)
- 抽象性：只要求“能在参数 U 处给出 3D 点”，具体怎么得到 3D 点由子类决定（3D 曲线、PCurve+Surface、离散多边形等）

**BRep_Curve3D（BRep_GCurve + 真实 3D 曲线）**
- 一句话对应：BRep_GCurve + Geom_Curve（真实 3D 几何曲线）；见 [BRep_Curve3D.hxx:L37-L77](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_Curve3D.hxx#L37-L77)
- 构造逻辑：基类范围直接取 3D 曲线自身的 First/Last（若曲线为空则用 RealFirst/RealLast），并保存 myCurve；见 [BRep_Curve3D.cxx:L29-L40](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_Curve3D.cxx#L29-L40)
- 几何求值：D0 直接调用 myCurve->Value(U) 得到 3D 点；见 [BRep_Curve3D.cxx:L44-L51](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_Curve3D.cxx#L44-L51)
- 语义：这就是最直接的“边的 3D 几何表示”，边的空间形状由 Geom_Curve 定义，BRep 只是在拓扑层面关联这条曲线并附带 Location 与裁剪范围

**BRep_CurveOnSurface（BRep_GCurve + PCurve + Surface）**
- 一句话对应：BRep_GCurve + 2D 参数曲线 PCurve + 对应曲面 Surface（用于从 UV 映射回 3D）；见 [BRep_CurveOnSurface.hxx:L40-L109](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_CurveOnSurface.hxx#L40-L109)
- 构造逻辑：范围取 PCurve 的 First/Last；保存 PCurve 与 Surface；Location 表示曲面的放置变换；见 [BRep_CurveOnSurface.cxx:L32-L45](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_CurveOnSurface.cxx#L32-L45)
- 几何求值（关键）：D0 先在 PCurve 上取 (u,v)，再用 Surface->Value(u,v) 得到 3D 点，最后应用 Location 变换；见 [BRep_CurveOnSurface.cxx:L49-L58](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_CurveOnSurface.cxx#L49-L58)
- UV 端点缓存：myUV1/myUV2 是范围端点处的 (u,v)，在范围变化时 Update 重新计算，用于加速或边界处理；见 [BRep_CurveOnSurface.hxx:L103-L109](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_CurveOnSurface.hxx#L103-L109)、[BRep_CurveOnSurface.cxx:L113-L127](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_CurveOnSurface.cxx#L113-L127)
- 语义：它描述的是“边在某一面上的参数轨迹”，边在面上的 2D 走向由 PCurve 给出，面把 2D 参数域映射成 3D 点，从而恢复空间几何

**小结（把你的一句话落到实现）**
- “曲线表示（带 Location）”来自 BRep_CurveRepresentation 的 Location；见 [BRep_CurveRepresentation.hxx:L44-L124](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_CurveRepresentation.hxx#L44-L124)
- “参数范围 [First, Last]”是 BRep_GCurve 的核心增量；见 [BRep_GCurve.hxx:L41-L69](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_GCurve.hxx#L41-L69)
- “真正的 3D 几何曲线”落实为 BRep_Curve3D::myCurve 并在 D0 直接取 Value(U)；见 [BRep_Curve3D.hxx:L37-L77](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_Curve3D.hxx#L37-L77)、[BRep_Curve3D.cxx:L44-L51](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_Curve3D.cxx#L44-L51)
- “PCurve + Surface（用来从 UV 映射回 3D）”落实为 BRep_CurveOnSurface 的 D0 三步流程；见 [BRep_CurveOnSurface.cxx:L49-L58](file:///c:/Users/lp/Desktop/OCCT/src/ModelingData/TKBRep/BRep/BRep_CurveOnSurface.cxx#L49-L58)

如果你还需要把这三类与 Edge 的几何表示列表（比如 BRep_TEdge 内部如何存放多种 CurveRepresentation）对应起来，我可以继续把那部分源码也拆解说明。
